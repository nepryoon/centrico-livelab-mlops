name: CD - Staging (ECS)

on:
  push:
    branches: ["main"]
    paths:
      - "services/inference/**"
      - ".github/workflows/cd-staging.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: cd-staging
  cancel-in-progress: true

jobs:
  deploy:
    name: Build, push to ECR, deploy to ECS (staging)
    runs-on: ubuntu-latest
    environment: staging

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

      ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
      ECS_SERVICE: ${{ vars.ECS_SERVICE }}
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

      CONTAINER_NAME: ${{ vars.CONTAINER_NAME || 'inference' }}

      # ⚠️ NON usare DOCKER_CONTEXT: Docker CLI lo interpreta come "docker context"
      BUILD_CONTEXT: services/inference
      DOCKERFILE_PATH: services/inference/Dockerfile

      ALB_URL: ${{ vars.ALB_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide whether to deploy (skip if only .md changed)
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"

          # On some pushes, 'before' can be all zeros. Fallback to previous commit.
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE="$(git rev-parse "${SHA}~1" 2>/dev/null || echo "")"
          fi

          if [[ -z "$BEFORE" ]]; then
            echo "deploy_needed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED="$(git diff --name-only "$BEFORE" "$SHA" || true)"
          echo "Changed files:"
          echo "$CHANGED"

          # Deploy if there is at least one non-markdown file changed
          if echo "$CHANGED" | grep -qvE '\.md$'; then
            echo "deploy_needed=true" >> "$GITHUB_OUTPUT"
          else
            echo "deploy_needed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip notice
        if: ${{ steps.changes.outputs.deploy_needed != 'true' }}
        run: |
          echo "Only markdown changes detected -> skipping deploy."

      - name: Configure AWS credentials (OIDC)
        if: ${{ steps.changes.outputs.deploy_needed == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR (password-stdin)
        if: ${{ steps.changes.outputs.deploy_needed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin \
              "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

      - name: Compute image URIs
        if: ${{ steps.changes.outputs.deploy_needed == 'true' }}
        id: image
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_TAG="${GITHUB_SHA}"
          IMAGE_URI_SHA="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
          IMAGE_URI_BOOTSTRAP="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:bootstrap"
          echo "image_uri_sha=${IMAGE_URI_SHA}" >> "$GITHUB_OUTPUT"
          echo "image_uri_bootstrap=${IMAGE_URI_BOOTSTRAP}" >> "$GITHUB_OUTPUT"

      - name: Build & Push Docker images to ECR (sha + bootstrap)
        if: ${{ steps.changes.outputs.deploy_needed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          docker build \
            -f "${DOCKERFILE_PATH}" \
            -t "${{ steps.image.outputs.image_uri_sha }}" \
            -t "${{ steps.image.outputs.image_uri_bootstrap }}" \
            "${BUILD_CONTEXT}"

          docker push "${{ steps.image.outputs.image_uri_sha }}"
          docker push "${{ steps.image.outputs.image_uri_bootstrap }}"

      - name: Deploy to ECS (register new task def + update service)
        if: ${{ steps.changes.outputs.deploy_needed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          TASK_DEF_ARN="$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --query 'services[0].taskDefinition' \
            --output text)"

          aws ecs describe-task-definition \
            --task-definition "${TASK_DEF_ARN}" \
            --query 'taskDefinition' \
            --output json > taskdef.json

          jq --arg IMAGE "${{ steps.image.outputs.image_uri_sha }}" \
             --arg NAME "${CONTAINER_NAME}" \
             '
             .containerDefinitions |= (map(if .name == $NAME then .image = $IMAGE else . end)) |
             del(
               .taskDefinitionArn,
               .revision,
               .status,
               .requiresAttributes,
               .compatibilities,
               .registeredAt,
               .registeredBy
             )
             ' taskdef.json > taskdef-new.json

          NEW_TASK_DEF_ARN="$(aws ecs register-task-definition \
            --cli-input-json file://taskdef-new.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)"

          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --task-definition "${NEW_TASK_DEF_ARN}" \
            --force-new-deployment > /dev/null

          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}"

      - name: Smoke test (optional, with retry)
        if: ${{ steps.changes.outputs.deploy_needed == 'true' && env.ALB_URL != '' }}
        shell: bash
        run: |
          set -euo pipefail
          URL="${ALB_URL}/health"
          echo "Smoke test: ${URL}"

          for i in {1..15}; do
            if curl -fsS "${URL}" >/dev/null; then
              echo "OK"
              exit 0
            fi
            echo "Not ready yet (attempt ${i}/15) - sleeping 5s"
            sleep 5
          done

          echo "Smoke test failed after retries"
          curl -i "${URL}" || true
          exit 1
